{% extends "base.html" %}
{% block title %}Event Details · LocalGig{% endblock %}

{% block header %}
<!-- Hero Header -->
<div class="hero-section py-5 bg-light border-bottom">
  <div class="container">
    <h1 class="display-5 fw-bold">{{ event.title }}</h1>
    <p class="lead mb-0">
      {{ event.venue_name }} · {{ event.event_date.strftime("%I:%M %p").lstrip("0") }}
      · {{ event.starts_at.strftime("%I:%M %p").lstrip("0") }} {{ event.ends_at.strftime("%I:%M %p").lstrip("0") }}
    </p>
  </div>
</div>
<!-- Handling for any cancellations / inactivene / sold out nature of events -->
<!-- Uses Calculations in models -->
{% if event.cancelled %}
  <div class="alert alert-secondary text-center m-0 rounded-0" role="alert">
    <strong>Event Cancelled</strong> — This event is no longer active.
  </div>
{% elif event.status == "Sold Out" %}
  <div class="alert alert-warning text-center m-0 rounded-0" role="alert">
    <strong>Sold Out!</strong> No more tickets are available.
  </div>
{% elif event.status == "Inactive" %}
  <div class="alert alert-light text-center m-0 rounded-0" role="alert">
    <strong>Past Event</strong> — This event has already ended.
  </div>
{% endif %}
{% endblock %}


{% block content %}
<div class="container my-5">
  <div class="row">
    <!-- Event Info -->
    <div class="col-lg-8">
      <!-- Event Image -->
      {% if event.image_url %}
        <img src="{{ event.image_url }}" class="img-fluid rounded mb-4" alt="{{ event.title }}">
      {% else %}
        <img src="{{ url_for('static', filename='default-event.jpg') }}" class="img-fluid rounded mb-4" alt="Event">
      {% endif %}

      <!-- About -->
      <h3>About the Event</h3>
      <p>{{ event.description }}</p>

      <!-- Event Details -->
      <!-- Created using event id selected or created, uses GET from views to display -->
      <h4 class="mt-4">Event Details</h4>
      <ul class="list-unstyled">
        <li><strong>Artist:</strong> {{ event.artist_name }}</li>
        <li><strong>Genre:</strong> {{ event.genre }}</li>
        <li><strong>Capacity:</strong> {{ event.capacity }}</li>
        <li><strong>Tickets Remaining:</strong> {{ event.tickets_available }}</li>
        <li><strong>Venue:</strong> {{ event.venue_name }}</li>
        <li><strong>Location:</strong> {{ event.location }}</li>
      </ul>

      <!-- Cancel button for owner -->
      {% if current_user.is_authenticated and current_user.id == event.owner_id and not event.cancelled %}
        <form method="post" action="{{ url_for('events.cancel_event', event_id=event.event_id) }}" class="mt-3">
          {{ comment_form.csrf_token }}
          <button type="submit" class="btn btn-outline-danger btn-sm"
                  onclick="return confirm('Cancel this event? This cannot be undone.');">
            Cancel Event
          </button>
        </form>
      {% endif %}

      <!-- Comments Section -->
      <div class="comment-section mt-5">
        <h4>Comments {% if comments %}<span class="text-muted">({{ comments|length }})</span>{% endif %}</h4>

        {% if comments %}
          {% for c in comments %}
            <div class="comment py-3 border-bottom">
              <div class="d-flex align-items-center mb-1">
                <strong class="me-2">{{ c.user.username }}</strong>
                <small class="text-muted">{{ c.created_at.strftime("%I:%M %p").lstrip("0") }}</small>
              </div>
              <p class="mb-0">{{ c.body }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
        {% endif %}

        {% if current_user.is_authenticated %}
          <form class="mt-4" method="post" action="{{ url_for('events.post_comment', event_id=event.event_id) }}">
            {{ comment_form.csrf_token }}
            <div class="mb-2">
              {{ comment_form.body }}
              {% for err in comment_form.body.errors %}
                <div class="invalid-feedback d-block">{{ err }}</div>
              {% endfor %}
            </div>
            {{ comment_form.submit }}
          </form>
        {% else %}
          <div class="alert alert-light border mt-4" role="alert">
            <a href="{{ url_for('auth.login') }}" class="alert-link">Log in</a> to post a comment.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Booking Info</h5>
          <p><strong>Status:</strong> {{ event.status }}</p>
          <p><strong>Date:</strong> {{ event.event_date.strftime("%I:%M %p").lstrip("0") }}</p>
          <p><strong>Start Time:</strong> {{ event.starts_at.strftime("%I:%M %p").lstrip("0") }}</p>
          <p><strong>End Time:</strong> {{ event.ends_at.strftime("%I:%M %p").lstrip("0") }}</p>
          <p><strong>Venue:</strong> {{ event.venue_name }}</p>
          <p><strong>Location:</strong> {{ event.location }}</p>
        </div>

        
      </div>
      <div class="d-flex justify-content-between align-items-center mt-4">
          <a href="{{ url_for('ticket.buy_ticket') }}" class="btn btn-lg btn-primary">Buy Tickets</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}